

// Функция ЗапретРедактированияРолей используется для
// управления поведением подсистем Пользователи и ВнешниеПользователи,
// когда требуется переключится в режим автоустановки ролей пользователей ИБ,
// например, при встраивании подсистемы УправлениеДоступом.
//
// Возвращаемое значение:
//  Булево.
//
Функция ЗапретРедактированияРолей() Экспорт
	
	// УправлениеДоступом
	
	// Роли устанавливаются автоматически по данным групп доступа
	// через связь: ПользователиГруппыДоступа -> Профиль -> РолиПрофиля
	Возврат Истина;
	
	// Конец УправлениеДоступом
	
	Возврат Ложь;
	
КонецФункции

// Процедура ИзменитьДействияВФорме позволяет переопределить
// поведение форм пользователя, внешнего пользователя, группы внешних пользователей
// когда это требуется, например, при встараивании подсистемы "Управление доступом".
//
// Параметры:
//  Ссылка - СправочникСсылка.Пользователи,
//           СправочникСсылка.ВнешниеПользователи,
//           СправочникСсылка.ГруппыВнешнихПользователей
//           ссылка на пользователя, внешнего пользователя или группу внешних пользователей
//           при создании формы.
//
//  ДействияВФорме - Структура (со свойствами типа Строка):
//           Роли                   = "", "Просмотр",     "Редактирование"
//           КонтактнаяИнформация   = "", "Просмотр",     "Редактирование"
//           СвойстваПользователяИБ = "", "ПросмотрВсех", "РедактированиеВсех", РедактированиеСвоих"
//           СвойстваЭлемента       = "", "Просмотр",     "Редактирование"
//           
//           Для групп внешних пользователей КонтактнаяИнформация и СвойстваПользователяИБ не существуют.
//
Процедура ИзменитьДействияВФорме(Знач Ссылка = Неопределено, Знач ДействияВФорме) Экспорт
	
	// УправлениеДоступом
	ДействияВФорме.Роли = "";
	// Конец УправлениеДоступом
	
КонецПроцедуры

// Обработчик события ПриЗаписи пользователя информационной базы
// вызывается из процедуры ЗаписатьПользователяИБ(), если пользователь
// был действительно записан.
//
// Параметры:
//  СтарыеСвойства - Структура, см. параметры возвращаемые функцией Пользователи.ПрочитатьПользователяИБ()
//  НовыеСвойства  - Структура, см. параметры возвращаемые функцией Пользователи.ЗаписатьПользователяИБ()
//
Процедура ПриЗаписиПользователяИнформационнойБазы(Знач СтарыеСвойства, Знач НовыеСвойства) Экспорт
	
	// РаботаСФайлами
	Если ЗначениеЗаполнено(СтарыеСвойства.ПользовательИнфБазыИмя) И
	     ВРег(СтарыеСвойства.ПользовательИнфБазыИмя) <> ВРег(НовыеСвойства.ПользовательИнфБазыИмя) Тогда
		
		ФайловыеФункцииПереопределяемый.ПеренестиНастройкиПриСменеИмениПользователя(
					СтарыеСвойства.ПользовательИнфБазыИмя, НовыеСвойства.ПользовательИнфБазыИмя);
	КонецЕсли;
	// Конец РаботаСФайлами
	
КонецПроцедуры

// Обработчик события ПослеУдаления пользователя информационной базы
// вызывается из процедуры УдалитьПользователяИБ(), если пользователь
// был действительно удален.
//
// Параметры:
//  СтарыеСвойства - Структура, см. параметры возвращаемые функцией Пользователи.ПрочитатьПользователяИБ()
//
Процедура ПослеУдаленияПользователяИнформационнойБазы(Знач СтарыеСвойства) Экспорт
	
	
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// Обработчики записи первого администратора

// Обработчик события ТекстВопросаПередЗаписьюПервогоАдминистратора вызывается
// из формы пользователя в обработчике перед записью,
// чтобы изменить текст вопроса пользователю,
// например, для подсистемы УправлениеДоступом.
//  Вызов происходит, если установлен ЗапретРедактированияРолей
// и количество пользователей информационной базы равно нулю.
// 
Процедура ТекстВопросаПередЗаписьюПервогоАдминистратора(ТекстВопроса) Экспорт
	
	// УправлениеДоступом
	ТекстВопроса = НСтр("ru = 'Первый пользователь информационной базы должен иметь полные права.
	                          |Пользователь будет добавлен в группу доступа Администраторы. Продолжить?'")
	// Конец УправлениеДоступом
	
КонецПроцедуры

// Обработчик события ПриЗаписиПервогоАдминистратора вызывается
// из формы пользователя в обработчике ПриЗаписиНаСервере,
// из функции Пользователи.ОшибкаАвторизации() при авторизации администратора,
// когда нет ни одного администратора зарегистрированного в справочнике Пользователи
//  Это нужно, например, для подсистемы УправлениеДоступом,
// чтобы добавить первого администратора в группу доступа Администраторы
// 
// Параметры:
//  Пользователь - СправочникСсылка.Пользователи (изменение объекта запрещено)
//
Процедура ПриЗаписиПервогоАдминистратора(Пользователь) Экспорт
	
	// УправлениеДоступом
	
	// Первый администратор автоматически добавляется в группу доступа Администраторы
	Объект = Справочники.ГруппыДоступа.Администраторы.ПолучитьОбъект();
	Если Объект.Пользователи.Найти(Пользователь, "Пользователь") = Неопределено Тогда
		Объект.Пользователи.Добавить().Пользователь = Пользователь;
		Объект.ОбменДанными.Загрузка = Истина;
		Объект.Записать();
	КонецЕсли;
	
	// Конец УправлениеДоступом
	
КонецПроцедуры

// Обработчик события ПослеЗаписиПервогоАдминистратораПриАвторизации вызывается
// из функции Пользователи.ОшибкаАвторизации() при авторизации первого администратора,
// когда администратор не зарегистрированн в справочнике Пользователи
//  Это нужно, например, для подсистемы УправлениеДоступом,
// чтобы сообщить, что первый администратор добавлен в группу доступа Администраторы
// 
// Параметры:
//  Комментарий  - Строка - начальное значение задано, можно переустановить,
//                 комментарий записывается в журнал регистрации.
//
Процедура ПослеЗаписиПервогоАдминистратораПриАвторизации(Комментарий) Экспорт
	
	// УправлениеДоступом
	Комментарий = НСтр("ru = 'Обнаружено, что пользователь информационной базы
	                         |с ролью ""Полные права"" был создан в Конфигураторе:
	                         |
	                         |- пользователь не найден в справочнике Пользователи,
	                         |- пользователь зарегистрирован в справочнике Пользователи,
	                         |- пользователь добавлен в группу доступа Администраторы.
	                         |
	                         |Пользователей информационной базы следует создавать в режиме 1С:Предприятия.'");
	// Конец УправлениеДоступом
	
КонецПроцедуры

